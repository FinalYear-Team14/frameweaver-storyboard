{% extends "base.html" %}

{% block title %}Create New Story{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="page-title">Create New Storyboard</h1>
        </div>
    </div>

    <div class="row">
        <!-- Left sidebar with story options -->
        <div class="col-md-3">
            <div class="card mb-4 text-center">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-pen-fancy me-2"></i>Story Templates
                    </h5>
                </div>
                <div class="card-body">
                    <img src="{{ url_for('static', filename='favicon1.png') }}" class="img-fluid rounded mb-3" alt="Logo">
                    <p>Choose a template to start your story</p>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-body p-0">
                    <a href="#" id="n-story-btn" class="d-block py-3 px-4 text-decoration-none border-bottom border-dark story-template-btn">
                        <i class="fas fa-sitemap me-2"></i>Multi-Character Story<br>
                        <p>Complex narrative with multiple storylines</p>
                    </a>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-body p-0">
                    <a href="#" id="3-story-btn" class="d-block py-3 px-4 text-decoration-none border-bottom border-dark story-template-btn">
                        <i class="fas fa-layer-group me-2"></i>Three-Act Structure<br>
                        <small >Beginning, middle, and end</small>
                    </a>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-body p-0">
                    <a href="#" id="2-story-btn" class="d-block py-3 px-4 text-decoration-none border-bottom border-dark story-template-btn">
                        <i class="fas fa-user-friends me-2"></i>Dual <br>
                        <small >Two characters interacting</small>
                    </a>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-body p-0">
                    <a href="#" id="1-story-btn" class="d-block py-3 px-4 text-decoration-none story-template-btn">
                        <i class="fas fa-user me-2"></i>Hero's Journey<br>
                        <small >Single character adventure</small>
                    </a>
                </div>
            </div>
        </div>

        <!-- Main content area with panels -->
        <div class="col-md-9">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-film me-2"></i>Storyboard Panels
                    </h5>
                </div>
                <div class="card-body">
                    <form id="story-form" method="POST" action="{{ url_for('create_story') }}">
                        <div class="mb-4">
                            <input type="text" class="form-control form-control-lg" id="title" name="title" placeholder="Enter an engaging title for your story..." required>
                        </div>

                        <div class="panel-container mb-4" id="panel-grid">
                            <!-- Panels will be generated dynamically -->
                            <div class="panel" id="panel-1">
                                <div class="panel-label">Scene 1</div>
                                <div class="d-flex justify-content-center align-items-center h-100">
                                    <div class="text-center">
                                        <i class="fas fa-image fa-3x mb-3 text-muted"></i>
                                        <p class="mb-0 text-muted">Generate image</p>
                                    </div>
                                </div>
                                <div class="panel-controls">
                                    <div class="panel-control" onclick="generatePanel(1)">
                                        <i class="fas fa-sync"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="panel" id="panel-2">
                                <div class="panel-label">Scene 2</div>
                                <div class="d-flex justify-content-center align-items-center h-100">
                                    <div class="text-center">
                                        <i class="fas fa-image fa-3x mb-3 text-muted"></i>
                                        <p class="mb-0 text-muted">Generate image</p>
                                    </div>
                                </div>
                                <div class="panel-controls">
                                    <div class="panel-control" onclick="generatePanel(2)">
                                        <i class="fas fa-sync"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="panel" id="panel-3">
                                <div class="panel-label">Scene 3</div>
                                <div class="d-flex justify-content-center align-items-center h-100">
                                    <div class="text-center">
                                        <i class="fas fa-image fa-3x mb-3 text-muted"></i>
                                        <p class="mb-0 text-muted">Generate image</p>
                                    </div>
                                </div>
                                <div class="panel-controls">
                                    <div class="panel-control" onclick="generatePanel(3)">
                                        <i class="fas fa-sync"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="panel" id="panel-4">
                                <div class="panel-label">Scene 4</div>
                                <div class="d-flex justify-content-center align-items-center h-100">
                                    <div class="text-center">
                                        <i class="fas fa-image fa-3x mb-3 text-muted"></i>
                                        <p class="mb-0 text-muted">Generate image</p>
                                    </div>
                                </div>
                                <div class="panel-controls">
                                    <div class="panel-control" onclick="generatePanel(4)">
                                        <i class="fas fa-sync"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="panel" id="panel-5">
                                <div class="panel-label">Scene 5</div>
                                <div class="d-flex justify-content-center align-items-center h-100">
                                    <div class="text-center">
                                        <i class="fas fa-image fa-3x mb-3 text-muted"></i>
                                        <p class="mb-0 text-muted">Generate image</p>
                                    </div>
                                </div>
                                <div class="panel-controls">
                                    <div class="panel-control" onclick="generatePanel(5)">
                                        <i class="fas fa-sync"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="panel" id="panel-6">
                                <div class="panel-label">Scene 6</div>
                                <div class="d-flex justify-content-center align-items-center h-100">
                                    <div class="text-center">
                                        <i class="fas fa-image fa-3x mb-3 text-muted"></i>
                                        <p class="mb-0 text-muted">Generate image</p>
                                    </div>
                                </div>
                                <div class="panel-controls">
                                    <div class="panel-control" onclick="generatePanel(6)">
                                        <i class="fas fa-sync"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Navigation arrows -->
                        <div class="position-relative my-4">
                            <div class="nav-arrow left">
                                <i class="fas fa-chevron-left"></i>
                            </div>
                            <div class="nav-arrow right">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="story_outline" class="form-label mb-2">
                                <i class="fas fa-pencil-alt me-2"></i>Your Story
                            </label>
                            <textarea id="story_outline" name="story_outline" class="form-control" placeholder="Describe your story in detail. The more specific you are, the better your storyboard will be..." rows="5" required></textarea>
                        </div>

                        <div class="d-flex justify-content-between align-items-center">
                            <div class="form-check mb-0">
                                <input class="form-check-input" type="checkbox" id="enhance" name="enhance" checked>
                                <label class="form-check-label" for="enhance">
                                    <i class="fas fa-magic me-2"></i>Enhance story with AI
                                </label>
                            </div>

                            <button type="submit" class="btn btn-primary px-4 py-2">
                                <i class="fas fa-wand-magic-sparkles me-2"></i>Generate Storyboard
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Panel generation function
    function generatePanel(panelNumber) {
        const panel = document.getElementById(`panel-${panelNumber}`);
        const storyText = document.getElementById('story_outline').value;

        if (!storyText) {
            alert('Please enter a story outline first!');
            return;
        }

        // Add loading indicator
        panel.innerHTML = '<div class="d-flex justify-content-center align-items-center h-100"><div class="loading-spinner"></div></div>';

        // Make API call to generate panel
        fetch('/api/generate-panel', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                scene_text: storyText,
                panel_number: panelNumber
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                panel.innerHTML = `
                    <img src="${data.image_url}" alt="Panel ${panelNumber}">
                    <div class="panel-label">Scene ${panelNumber}</div>
                    <div class="panel-controls">
                        <div class="panel-control" onclick="generatePanel(${panelNumber})">
                            <i class="fas fa-sync"></i>
                        </div>
                    </div>
                `;
            } else {
                panel.innerHTML = `
                    <div class="panel-label">Scene ${panelNumber}</div>
                    <div class="d-flex justify-content-center align-items-center h-100">
                        <div class="text-danger">Error: ${data.error}</div>
                    </div>
                    <div class="panel-controls">
                        <div class="panel-control" onclick="generatePanel(${panelNumber})">
                            <i class="fas fa-sync"></i>
                        </div>
                    </div>
                `;
            }
        })
        .catch(error => {
            panel.innerHTML = `
                <div class="panel-label">Scene ${panelNumber}</div>
                <div class="d-flex justify-content-center align-items-center h-100">
                    <div class="text-danger">Network error</div>
                </div>
                <div class="panel-controls">
                    <div class="panel-control" onclick="generatePanel(${panelNumber})">
                        <i class="fas fa-sync"></i>
                    </div>
                </div>
            `;
            console.error('Error:', error);
        });
    }

    // Story template selection
    document.getElementById('1-story-btn').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('story_outline').value = "A hero embarks on a journey of self-discovery. After facing numerous challenges, they overcome their greatest fear and return home transformed.";
        document.getElementById('title').value = "The Hero's Quest";
    });

    document.getElementById('2-story-btn').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('story_outline').value = "Two characters with opposing viewpoints meet and initially clash. Through their interactions, they gradually understand each other's perspective and form an unexpected bond.";
        document.getElementById('title').value = "Unlikely Alliance";
    });

    document.getElementById('3-story-btn').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('story_outline').value = "Act 1: A character discovers a hidden truth. Act 2: They face resistance when trying to reveal it to others. Act 3: After nearly giving up, they find a way to prove their discovery, changing everything.";
        document.getElementById('title').value = "The Revelation";
    });

    document.getElementById('n-story-btn').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('story_outline').value = "Multiple characters navigate their interconnected lives in a small town. Each has their own goals and secrets, but a single event brings them all together, forcing them to confront their past and reconsider their future.";
        document.getElementById('title').value = "Converging Paths";
    });

    // Navigation arrows functionality
    // This would be implemented for multi-page storyboards
    document.querySelector('.nav-arrow.left').addEventListener('click', function() {
        // Navigate to previous page of panels
        alert('Navigate to previous page of panels');
    });

    document.querySelector('.nav-arrow.right').addEventListener('click', function() {
        // Navigate to next page of panels
        alert('Navigate to next page of panels');
    });
</script>
{% endblock %}